name: Deploy Documentation

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v2.1.3, etc.

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[docs]"

      - name: Build documentation
        run: |
          # Find or create docs directory
          if [ -d "python-sdk/docs" ]; then
            cd python-sdk/docs
          elif [ -d "docs" ]; then
            cd docs
          else
            mkdir -p docs
            cd docs
          fi
          
          # Create a basic conf.py if it doesn't exist
          if [ ! -f conf.py ]; then
            cat > conf.py << 'EOF'
          import sys
          import os
          
          project = 'Test Project'
          copyright = '2025'
          author = 'Test Author'
          
          extensions = [
              'sphinx.ext.autodoc',
              'sphinx.ext.viewcode',
              'sphinx_rtd_theme',
              'sphinx_autodoc_typehints',
              'myst_parser',
          ]
          
          html_theme = 'sphinx_rtd_theme'
          html_static_path = ['_static']
          EOF
            echo "" > index.rst
          fi
          sphinx-build -b html . _build/html

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: TSU-MVPE/amalgamationai-doc
          token: ${{ secrets.DEPLOY_TOKEN }}
          path: target-repo

      - name: Deploy to target repository
        run: |
          # Copy built documentation to target repo
          SOURCE_DIR="python-sdk/docs/_build/html"
          if [ ! -d "$SOURCE_DIR" ]; then
            SOURCE_DIR="docs/_build/html"
          fi
          
          if [ ! -d "$SOURCE_DIR" ]; then
            echo "Error: Documentation not found at expected location"
            exit 1
          fi
          
          # Create docs directory in target repo if it doesn't exist
          mkdir -p target-repo/docs
          
          # Sync files to target repo's docs directory using rsync
          # --delete removes files in target that don't exist in source
          # -a preserves permissions and timestamps, -v shows progress
          rsync -av --delete "$SOURCE_DIR"/ target-repo/docs/
          
          # Create .nojekyll file to disable Jekyll processing on GitHub Pages
          # This allows directories starting with _ (like _static, _sources) to be served
          touch target-repo/docs/.nojekyll
          
          # Change to target repo directory for git operations
          cd target-repo
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit and push
          git add .
          git commit -m "Deploy documentation from tag ${{ github.ref_name }}" || exit 0
          git push origin main

